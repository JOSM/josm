name: Java CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ${{ matrix.os }}
    env:
      LANG: en_US.UTF-8
    strategy:
      fail-fast: false
      matrix:
        # test against latest update of each major Java version, as well as specific updates of LTS versions:
        java: [8, 11, 14]
        os: [ubuntu-latest, macos-latest, windows-latest]
        headless: ["true", "false"]
        exclude:
          - headless: "true"
            os: macos-latest
          - headless: "true"
            os: windows-latest
          - headless: "false"
            os: ubuntu-latest
    name: Java ${{ matrix.java }} on ${{ matrix.os }} with headless=${{ matrix.headless }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 32
      - name: Setup java
        uses: actions/setup-java@v1.3.0
        with:
          java-version: ${{ matrix.java }}
      - name: Install ant
        run: curl -s https://downloads.apache.org/ant/binaries/apache-ant-1.10.8-bin.tar.gz | tar -xz
      - name: Print ant version
        run: ./apache-ant-1.10.8/bin/ant -version
      - name: Build with Ant, headless ${{ matrix.headless }}
        run: |
          ANT="./apache-ant-1.10.8/bin/ant -DnoJavaFX=true test-unit-hardfail"
          if [ "${{ matrix.headless }}" == "true" ]; then
            xvfb-run $ANT -Dtest.headless=true
          else
            $ANT -Dtest.headless=false
          fi
      - name: Dump errors if failed
        if: ${{ failure() }}
        run: "grep -L ', Failures: 0, Errors: 0, ' test/report/*.txt | xargs cat"
      - name: Upload Ant reports
        uses: actions/upload-artifact@v2
        with:
          name: Ant reports
          path: test/report/*.txt
